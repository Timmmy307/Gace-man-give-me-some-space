<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GACE • Dashboard</title>
<style>
  body{margin:0;background:linear-gradient(180deg,#0b1120,#0f172a);color:#e5e7eb;font:16px/1.5 system-ui}
  .container{width:min(1200px,92%);margin-inline:auto}
  .glass{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px);border-radius:16px;padding:20px;margin-top:20px}
  button{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);color:#e5e7eb;cursor:pointer}
  button.primary{background:linear-gradient(135deg,#2563eb,#8b5cf6);border:none}
  input,select{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#e5e7eb}
  table{width:100%;border-collapse:collapse;margin-top:16px;min-width:900px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);white-space:nowrap;text-align:left}
  tbody tr:nth-child(even){background:rgba(255,255,255,.03)}
  .wrap{overflow-x:auto}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:#9ca3af}
</style>
</head>
<body>
<div class="container">
  <h1>GACE DNS Dashboard</h1>
  <div class="flex">
    <button id="logout">Sign Out</button>
    <button id="reload">Reload</button>
  </div>

  <div class="glass">
    <h3>Add New Record</h3>
    <div class="flex">
      <select id="type"><option>A</option><option>CNAME</option><option>TXT</option></select>
      <input id="name" placeholder="subdomain.gace.space"/>
      <input id="content" placeholder="1.1.1.1 or target.example.com"/>
      <input id="ttl" type="number" value="300" min="60"/>
      <select id="proxied"><option value="false">false</option><option value="true">true</option></select>
      <button class="primary" id="create">Create</button>
    </div>
    <p id="createMsg" class="muted"></p>
  </div>

  <div class="glass wrap">
    <h3>Existing Records</h3>
    <table id="table">
      <thead><tr><th>Type</th><th>Name</th><th>Content</th><th>TTL</th><th>Proxied</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
async function api(path, opt={}) {
  const res = await fetch(path, opt);
  try{return await res.json();}catch{return {ok:false,error:"bad_json"}}
}

// session check
(async()=>{
  const me = await api('/api/me');
  if(!me.ok || !me.user){location.href='/index.html';return;}
  loadRecords();
})();

const tbody=document.querySelector('#table tbody');
async function loadRecords(){
  tbody.innerHTML='<tr><td colspan="6">Loading…</td></tr>';
  const data=await api('/api/records');
  if(!data.result){tbody.innerHTML='<tr><td colspan="6">Error loading</td></tr>';return;}
  tbody.innerHTML='';
  data.result.forEach(rec=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="type" value="${rec.type}"></td>
      <td><input class="name" value="${rec.name}"></td>
      <td><input class="content" value="${rec.content}" style="min-width:300px"></td>
      <td><input class="ttl" type="number" value="${rec.ttl}"></td>
      <td><select class="proxied"><option value="true"${rec.proxied?' selected':''}>true</option><option value="false"${!rec.proxied?' selected':''}>false</option></select></td>
      <td>
        <button data-save="${rec.id}" class="primary">Save</button>
        <button data-del="${rec.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{
    if(!confirm('Delete this record?'))return;
    await fetch('/api/records/'+b.dataset.del,{method:'DELETE'});
    loadRecords();
  });

  document.querySelectorAll('[data-save]').forEach(b=>b.onclick=async()=>{
    const tr=b.closest('tr');
    b.textContent='Saving…';
    const body={
      type:tr.querySelector('.type').value,
      name:tr.querySelector('.name').value,
      content:tr.querySelector('.content').value,
      ttl:+tr.querySelector('.ttl').value,
      proxied:tr.querySelector('.proxied').value==='true'
    };
    const res=await fetch('/api/records/'+b.dataset.save,{
      method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
    });
    const j=await res.json();
    b.textContent=j.success?'Saved ✅':'Error ❌';
    setTimeout(()=>b.textContent='Save',1500);
  });
}

document.getElementById('create').onclick=async()=>{
  const body={
    type:type.value,name:name.value,content:content.value,
    ttl:+ttl.value,proxied:proxied.value==='true'
  };
  const res=await fetch('/api/records',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const j=await res.json();
  createMsg.textContent=j.success?'Created ✅':JSON.stringify(j.errors||j);
  loadRecords();
};

document.getElementById('logout').onclick=async()=>{await api('/api/logout',{method:'POST'});location.href='/index.html';};
document.getElementById('reload').onclick=loadRecords;
</script>
</body>
</html>
